<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="initial-scale=0.25">
<title>canvas sample</title>
	<style>
		canvas {
			position: relative;
			border:3px solid #000;
		}
		.canvas_1_ov {
			position: absolute;
			top: 10;
			left: 10;
			border:0px solid #000;
		}
		div#img-box{
		  border:3px solid #000;
		  width:4000px;
		}

		div#btn-box{
			position: fixed;
			bottom :0px;
		}
		button{
			width:700px;
			height:200px;
			font-size: 400%;
		}

		div#str1{
			font-size: 400%;
		}
	</style>
</head>
<body>

<table class="canvas_1_ov" id="canvas_1_ov" border="1"
width="4006" height="806" cellspacing="0" cellpadding="0" bordercolor="#000000">
<tr>
	<td bgcolor="#99CC00" nowrap></td>
	<td bgcolor="#eeeeee" nowrap></td>
	<td bgcolor="#99CC00" nowrap></td>
	<td bgcolor="#eeeeee" nowrap></td>
	<td bgcolor="#99CC00" nowrap></td>
	<td bgcolor="#eeeeee" nowrap></td>
</tr>
<tr>
	<td bgcolor="#eeeeee" nowrap></td>
	<td bgcolor="#99CC00" nowrap></td>
	<td bgcolor="#eeeeee" nowrap></td>
	<td bgcolor="#99CC00" nowrap></td>
	<td bgcolor="#eeeeee" nowrap></td>
	<td bgcolor="#99CC00" nowrap></td>
</tr><tr>
	<td bgcolor="#99CC00" nowrap></td>
	<td bgcolor="#eeeeee" nowrap></td>
	<td bgcolor="#99CC00" nowrap></td>
	<td bgcolor="#eeeeee" nowrap></td>
	<td bgcolor="#99CC00" nowrap></td>
	<td bgcolor="#eeeeee" nowrap></td>
</tr>
<tr>
	<td bgcolor="#eeeeee" nowrap></td>
	<td bgcolor="#99CC00" nowrap></td>
	<td bgcolor="#eeeeee" nowrap></td>
	<td bgcolor="#99CC00" nowrap></td>
	<td bgcolor="#eeeeee" nowrap></td>
	<td bgcolor="#99CC00" nowrap></td>
</tr>
</table>

<div id="wrapper">
<canvas id="canvassample" width="4000" height="800"></canvas>
</div>
<div style="padding:10px">
	<button type="button" onclick="ccc()">罫線OFF</button>
	<button type="button" onclick="ccc2()">罫線ON</button>
	<button type="button" onclick="clearCanvas()">リセット</button>
	<button type="button" onclick="aaa()">鉛筆</button>
	<button type="button" onclick="aaa2()">鉛筆（赤・太字）</button>
	<button type="button" onclick="bbb()">消しゴム（小）</button>
	<button type="button" onclick="bbb2()">消しゴム（大）</button>
	<div id="str1"><b>描画モード：鉛筆</b></div>
</div>
<div style="padding:10px">
    <button type="button" onclick="chgImg()" value="1">画像変換</button>
<h2>画像出力<h2>  
<div id="img-box"><img id="newImg"></div>

<script type="text/javascript">
var canvas = document.getElementById('canvassample'),
    ctx = canvas.getContext('2d'),
    moveflg = 0,
    Xpoint,
    Ypoint;

//初期値（サイズ、色、アルファ値）の決定
var defSize = 4,
    defColor = "#000";

// キャンバスを白色に塗る
ctx.fillStyle = 'rgb(255,255,255)';

// ストレージの初期化
var myStorage = localStorage;
window.onload = initLocalStorage();

// PC対応
canvas.addEventListener('mousedown', startPoint, false);
canvas.addEventListener('mousemove', movePoint, false);
canvas.addEventListener('mouseup', endPoint, false);
// スマホ対応
canvas.addEventListener('touchstart', startPoint, false);
canvas.addEventListener('touchmove', movePoint, false);
canvas.addEventListener('touchend', endPoint, false);

function startPoint(e){
  e.preventDefault();
  ctx.beginPath();

  
  Xpoint = e.layerX;
  Ypoint = e.layerY;
  
  ctx.moveTo(Xpoint, Ypoint);
}

function movePoint(e){
  if(e.buttons === 1 || e.witch === 1 || e.type == 'touchmove')
  {
    Xpoint = e.layerX;
    Ypoint = e.layerY;
    moveflg = 1;
    
    ctx.lineTo(Xpoint, Ypoint);
    ctx.lineCap = "round";
    ctx.lineWidth = defSize * 2;
    ctx.strokeStyle = defColor;
    ctx.stroke();
    
  }
}

function endPoint(e)
{

    if(moveflg === 0)
    {
       ctx.lineTo(Xpoint-1, Ypoint-1);
       ctx.lineCap = "round";
       ctx.lineWidth = defSize * 2;
       ctx.strokeStyle = defColor;
       ctx.stroke();
       
    }
    moveflg = 0;
  setLocalStoreage();
}

function clearCanvas(){
/*
    if(confirm('Canvasを初期化しますか？'))
    {
        initLocalStorage();
        temp = [];
        resetCanvas();
    }
*/
    initLocalStorage();
    temp = [];
    resetCanvas();
}

function resetCanvas() {
    ctx.clearRect(0, 0, ctx.canvas.clientWidth, ctx.canvas.clientHeight);
    ctx.fillStyle = 'rgb(255,255,255)';
}

function chgImg()
{
  var png = canvas.toDataURL();

  document.getElementById("newImg").src = png;
}

function initLocalStorage(){
    myStorage.setItem("__log", JSON.stringify([]));
}
function setLocalStoreage(){
    var png = canvas.toDataURL();
    var logs = JSON.parse(myStorage.getItem("__log"));

    setTimeout(function(){
        logs.unshift({0:png});

        myStorage.setItem("__log", JSON.stringify(logs));

        currentCanvas = 0;
        temp = [];
    }, 0);
}

function draw(src) {
    var img = new Image();
    img.src = src;

    img.onload = function() {
        ctx.drawImage(img, 0, 0);
    }
}

function aaa()
{
	defSize = 1*4;
	defColor = "#000";
	document.getElementById("str1").innerHTML="<b>描画モード：鉛筆</b>";
}
function aaa2()
{
	defSize = 3*4;
	defColor = "#e00";
	document.getElementById("str1").innerHTML="<b>描画モード：鉛筆（赤・太字）</b>";
}
function bbb()
{
	defSize = 10*4;
	defColor = "#fff";
	document.getElementById("str1").innerHTML="<b>描画モード：消しゴム(小)</b>";
}
function bbb2()
{
	defSize = 30*4;
	defColor = "#fff";
	document.getElementById("str1").innerHTML="<b>描画モード：消しゴム(大)</b>";
}
function ccc()
{
	document.getElementById("canvas_1_ov").style.display ="none";
}
function ccc2()
{
	document.getElementById("canvas_1_ov").style.display ="";
}
</script>

  </body>
</html>

